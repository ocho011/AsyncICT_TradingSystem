
# 웹소켓 데이터 처리 및 이벤트 발행 설계에 대한 논의

## 질문 1: 수신된 데이터는 봉 마감 여부와 상관없이 캔들 이벤트로 처리되어 이벤트 버스에 등록되나요?

네, 정확하게 이해하셨습니다.

`AsyncBinanceWebSocketClient.py`의 `_handle_message` 메소드를 보면, 바이낸스에서 kline(캔들) 데이터가 스트리밍되면 항상 `CandleEvent`를 생성합니다.

```python
# ... (코드 생략) ...
            if kline_data:
                # ... (코드 생략) ...
                candle_event = CandleEvent(
                    # ... (필드 생략) ...
                    is_closed=bool(kline_data['x'])
                )
                await self.event_bus.publish(candle_event)
# ... (코드 생략) ...
```

`is_closed=bool(kline_data['x'])` 부분에서 바이낸스가 보내주는 'x' 필드 값을 이용해 해당 캔들이 마감되었는지 여부를 `is_closed` 속성에 저장합니다.

결론적으로, **봉 마감 여부와 상관없이 모든 캔들 데이터는 `CandleEvent`로 만들어져 이벤트 버스에 등록(publish)됩니다.** 이벤트를 구독(consume)하는 다른 컴포넌트들이 `is_closed` 값을 보고 마감된 봉인지, 아니면 현재 진행 중인 봉의 실시간 업데이트인지 판단하여 각자의 로직을 처리하게 됩니다.

---

## 질문 2: 모든 이벤트를 발행하는 설계가 봉 마감 시에만 필터링해서 발행하는 설계 대비 어떤 장점이 있나요?

봉 마감 여부를 필터링하지 않고 모든 캔들 업데이트를 이벤트로 발행하는 설계는 다음과 같은 중요한 장점들을 가집니다.

### 1. 실시간 반응성 및 빠른 의사결정
가장 큰 장점은 **시스템의 반응 속도**입니다. 봉 마감까지 기다린다면 큰 지연이 발생할 수 있지만, 실시간으로 정보를 발행하면 다음과 같은 빠른 대응이 가능해집니다.

*   **실시간 리스크 관리:** 손절 라인이나 청산 가격 도달 시 즉시 대응할 수 있습니다.
*   **단타(Scalping) 전략:** 봉이 형성되는 과정에서의 미세한 가격 움직임을 포착하여 거래하는 전략을 구현할 수 있습니다.
*   **실시간 UI 업데이트:** 대시보드나 차트에 현재 가격 변동을 실시간으로 표시할 수 있습니다.

### 2. 시스템 유연성 및 확장성 증가
이벤트 발행자(Producer)는 데이터 전달의 책임만 가지며, 데이터 사용법은 구독자(Consumer)의 몫으로 남겨 시스템 전체의 유연성과 확장성을 높입니다.

*   **다양한 구독자 지원:** 어떤 구독자는 봉 마감 데이터만, 다른 구독자는 모든 실시간 가격 변동이 필요할 수 있습니다. 현재 설계는 이 모든 요구사항을 충족시킵니다.
*   **새로운 기능 추가 용이:** 미래에 새로운 전략이나 기능이 추가될 때, 발행자 코드를 수정할 필요 없이 새로운 구독자를 추가하기만 하면 됩니다.

### 3. 데이터의 완전성 및 풍부한 정보 제공
모든 데이터를 그대로 이벤트 버스에 전달함으로써, 시스템은 항상 **가장 완전하고 원시적인(raw) 데이터**를 갖게 됩니다.

*   **정교한 분석 가능:** 봉 내부의 가격 움직임까지 모두 보존하여 더 정교한 분석과 백테스팅이 가능합니다.
*   **디버깅 및 로깅:** 시스템의 모든 데이터 흐름을 기록하고 분석할 수 있어 문제 발생 시 원인 파악이 더 쉽습니다.

### 단점 및 고려사항
물론 이 설계의 단점은 **이벤트 버스와 구독자의 부하가 증가**한다는 것입니다. 따라서 구독자는 자신이 처리할 필요가 없는 이벤트를 빠르게 걸러내는 로직을 효율적으로 구현해야 합니다.

결론적으로, 현재 설계는 약간의 성능 부하를 감수하는 대신 **실시간성, 유연성, 확장성**이라는 더 큰 가치를 얻는, 현대적인 이벤트 기반 시스템에서 널리 사용되는 아키텍처 패턴입니다.
