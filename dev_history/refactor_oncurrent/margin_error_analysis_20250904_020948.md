# Binance API 'Margin is insufficient' 오류 분석 및 해결 방안

## 1. 오류 로그

```
2025-09-04 01:34:00,097 - infrastructure.binance.AsyncBinanceRestClient:53 - ERROR - API request failed: 400, message='Margin is insufficient.', url='https://fapi.binance.com/fapi/v1/order'
2025-09-04 01:34:00,098 - infrastructure.binance.AsyncOrderManager:75 - ERROR - Failed to place order for ETHUSDT. No result from API.
```

## 2. 현상 및 원인 분석

### 현상
계좌에 충분한 잔고($513)가 있고, 레버리지가 20x로 설정되어 있으며, 다른 미체결 주문이나 포지션이 없음에도 불구하고 API에서 '증거금 부족' 오류를 반환하며 주문이 거부됨.

### 근본 원인: 포지션 규모 계산의 허점
현재 포지션 크기는 다음 공식에 따라 결정된다:
`포지션 크기 (수량) = (계좌 잔고 * 리스크 비율) / |진입가 - 손절가|`

문제는 **`|진입가 - 손절가|` (손절 폭)이 매우 좁아질 때 발생**한다. 손절 폭이 0에 가까워지면, 계산된 포지션 크기는 비정상적으로 커지게 된다. 이로 인해 해당 포지션에 필요한 증거금이 실제 계좌 잔고를 초과하게 되어, 바이낸스 서버가 주문을 거부하는 것이다.

이는 코드의 계산 로직 자체의 오류라기보다는, 특정 시장 상황(매우 좁은 변동성 또는 얇은 오더블록)에서 발생할 수 있는 위험 관리 로직의 허점이다.

## 3. 해결 방안 제안

### 포지션 규모 안전장치(Safeguard) 추가

`AsyncRiskManager`의 `_calculate_position_size` 메서드 내에, 계산된 포지션의 총 명목 가치가 감당할 수 있는 한도를 초과하지 않도록 강제하는 안전장치를 추가한다.

**제안 로직:**
1. 기존 방식대로 리스크 기반 포지션 크기를 계산한다.
2. 계산된 포지션의 총 명목 가치(`포지션 크기 * 진입 가격`)를 구한다.
3. 설정 가능한 최대 명목 가치 한도(`계좌 잔고 * 레버리지`)와 비교한다.
4. 만약 계산된 포지션 가치가 한도를 초과하면, 포지션 크기를 최대 한도에 맞춰 강제로 줄인다.

**기대 효과:**
- 비정상적인 시장 상황에서도 과도하게 큰 포지션이 생성되는 것을 방지.
- '증거금 부족' 오류를 원천적으로 차단하여 시스템 안정성 향상.
- 일관성 있는 위험 관리 유지.
